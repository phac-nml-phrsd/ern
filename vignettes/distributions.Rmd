---
title: "Estimating parameters for various distributions used in `ern`"
output: 
  bookdown::html_document2:
      base_format: rmarkdown::html_vignette
      fig_caption: true
      number_sections: false
      global_numbering: true
vignette: >
  %\VignetteIndexEntry{Estimating parameters for various distributions used in `ern`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE, message = FALSE}
library(ern)

library(glue)
library(tibble)
library(tidyr)
library(dplyr)
library(ggplot2)
```

[Jump to estimated parameter values](#sec-params)

In order to calculate Rt from clinical reports or wastewater concentration, we need to assume a few quantities, including a generation interval distribution. The generation interval is the time between consecutive infections. Once we have a generation time distribution, we can take a daily incidence time series and use it to estimate a daily $\mathcal{R}_t$ time series by deconvolving incidence with the generation time distribution.

In order to estimate incidence, we need a few more pieces of information depending on the primary data source. For clinical case reports, we additionally need an incubation time distribution, which gives the time between infection and symptom onset, and a reporting delay distribution, which gives the time between symptom onset and a case report. For wastewater concentration, we need a fecal shedding distribution, which describes how individuals shed viral particles into wastewater over time during an infection.

This article focuses on quantifying families of distributions for the generation interval, incubation period, and fecal shedding. The reporting delay distribution is estimated directly from PHAC linelist data.

# Generation interval and incubation period distributions

## Available data

For COVID-19 in Canada, the most relevant distribution estimates come from analyzing Omicron infection data as the majority of lineages circulating in the country since January 2021 have been descendants of Omicron. [Manica _et al._ 2022](https://www.sciencedirect.com/science/article/pii/S2666776222001405) assume both the incubation period and generation interval are gamma distributed, and then they use Omicron infection data to estimate distribution parameters for each quantity, along with measures of uncertainty for each parameter.^[Note that Manica _et al._ estimate distributions for two different generation times but we will use the **intrinsic generation time**.]

```{r manica-table, echo = FALSE, fig.align="center", fig.cap='**Table 2 from [Manica _et al._ 2022](https://www.sciencedirect.com/science/article/pii/S2666776222001405)**. Original caption: "Estimates for the incubation period, diagnostic delay, intrinsic and realized generation time, and household serial intervals of the SARS-CoV-2 Omicron variant. Reported parameters of shape and scale for the incubation period and intrinsic generation time refer to a gamma distribution. Estimates of the incubation period are dervied from the analysis of 80 participants to a single superspreading event in Norway. Data taken from Brandal _et al_."'}
knitr::include_graphics("figs/manica-table.png",
                        dpi = 144)
```


Manica _et al._ give estimates for the mean, shape, and scale parameters of each family of (gamma) distributions (Figure \@ref(fig:manica-table)). However, **the uncertainty in each estimated parameter is reported in terms of a credible interval**, *i.e.* in a non-parametric way. We need each family of distributions to be specified in a _parameteric_ way, because of how we compute $\mathcal{R}_t$ with various sources of uncertainty: we generate an ensemble of simulations for the $\mathcal{R}_t$ time series, where for each individual simulation, we draw from the specified families of distributions (among other quantities) to select one distribution of each type to use for that specific calculation.

The following section describes how we generated parametric specifications for the families of generation interval and incubation period distributions from the non-parameteric uncertainties given by Manica _et al._

## Parameterizing families of distributions from non-parametric uncertainties

We will specify each family of gamma distributions with a mean and shape parameter (the "distribution parameters"), along with standard deviations about each of these two parameters. 

We assume that each distribution parameter is itself gamma distributed. The mean of this distribution is assumed to be the corresponding mean value listed in Figure \@ref(fig:manica-table). In order to estimate a standard deviation for this distribution, we assume that the credible interval bounds give quantiles and use them, along with a mean (equal to the mean estimate of the focal parameter) to fit shape parameter for a gamma distribution. Once we have the fitted shape parameter, we can calculate the corresponding standard deviation. 

For each family of gamma distributions, we need to fit distributions as described above over **two** parameters to specify it. We will perform two independent one-dimensional optimizations of the shape parameter for the distributions of the mean and the shape parameter of each gamma family.

The following code defines a function (`fit_sd()`) to perform the aforementioned one-dimensional optimization:

```{r optim}
# Fit a standard deviation for a gamma distribution
# given a mean and 95% quantiles
fit_sd <- function(mean, ci){
  
  # Score function for optimization
  # s = shape
  # m = assumed mean
  # ci_target = the 95% credible interval bounds, assumed to be 2.5% and 97.5% quantiles
  score_fun <- function(s, m, ci_target) {
    shape <- s
    scale <- m/s
    ci <- qgamma(c(0.025, 0.975), shape = shape, scale = scale)
    return(sum((ci-ci_target)^2))
  }

  # Optimize over shape
  opt_out <- optim(
    par = 1, 
    fn = score_fun,
    m = mean,
    ci_target = ci,
    lower = 0.0001, upper = 1000,
    method = "Brent"
  )
  
  # Get best shape parameter found and return associated standard deviation
  shape_best <- opt_out$par
  sd_best <- shape_to_sd(shape_best, mean)
  
  return(list(
    sd = sd_best,
    score = opt_out$value
  ))
}

# Helper function to compute a gamma's standard deviation given the shape and mean
shape_to_sd <- function(shape, mean) mean/sqrt(shape)
```

## Fitted parameter values {#sec-params}

We use the method above to generate fitted parameter values for each family of distributions, which are encoded in `ern::def_dist_generation_interval(pathogen = "sarscov2")` and `ern::def_dist_incubation_period(pathogen = "sarscov2")`. The parameters are summarised here in Tables \@ref(tab:summary-gen-int) (generation interval) and \@ref(tab:summary-inc-per) (incubation period).

```{r make_fit_table, echo = FALSE}
#' Make table summarizing parameters for each family of distributions
#'
#' @param mean.inputs list with elements `mean` (scalar) and `ci` (numeric vector of length 2) 
#' @param shape.inputs same format as `mean.inputs`
#'
#' @return tibble 
make_summary_table <- function(mean.inputs, shape.inputs){

  fit.mean <- fit_sd(mean = mean.inputs$mean, ci = mean.inputs$ci)
  fit.shape <- fit_sd(mean = shape.inputs$mean, ci = shape.inputs$ci)
  
  tb <- tribble(
    ~parameter,           ~`value type`,                 ~`value`,
    "distribution mean",  "mean (assumed)",              mean.inputs$mean,
    NA,                   "standard deviation (fitted)", fit.mean$sd,
    NA,                   "fit score",                   fit.mean$score,
    "distribution shape", "mean (assumed)",              shape.inputs$mean,
    NA,                   "standard deviation (fitted)", fit.shape$sd,
    NA,                   "fit score",                   fit.shape$score
  )
}
```

```{r display_table, echo = FALSE}
display_table <- function(tb, caption){
  knitr::kable(
    tb %>% replace_na(list(parameter = "")), 
    digits = 4,
    caption = caption
  )
}
```

```{r summary-gen-int, echo = FALSE}
summary.gen.int <- make_summary_table(
  mean.inputs = list(
    mean = 6.84,
    ci = c(5.72, 8.60)
  ),
  shape.inputs = list(
    mean = 2.39,
    ci = c(2.01, 3.34)
  )
)

display_table(summary.gen.int,
              caption = "Parameters for the family of generation interval distributions")
```

```{r summary-inc-per, echo = FALSE}
summary.inc.per <- make_summary_table(
  mean.inputs = list(
    mean = 3.49,
    ci = c(3.19, 3.77)
  ),
  shape.inputs = list(
    mean = 8.50,
    ci = c(6.14, 13.20)
  )
)

display_table(summary.inc.per,
              caption = "Parameters for the family of incubation period distributions")
```

The mean fitted distributions (that is, the distributions generated by taking the mean distribution mean and mean shape parameter) are illustrated in Figures \@ref(fig:plot-mean-gen-int) (generation interval) and \@ref(fig:plot-mean-inc-per) (incubation period).

```{r plot_mean_dist, echo = FALSE}
plot_mean_dist <- function(summary, max, title){
  summary <- fill(summary, parameter)
  mean = (summary 
    %>% filter(parameter == "distribution mean",
               `value type` == "mean (assumed)")
    %>% pull(value)
  )
  shape = (summary 
    %>% filter(parameter == "distribution shape",
               `value type` == "mean (assumed)")
    %>% pull(value)
  )
  
  y <- get_discrete_dist(list(
    dist = "gamma",
    mean = mean,
    mean_sd = NA,
    shape = shape,
    shape_sd = NA,
    max = max
  ))
  
  df <- tibble(x = 1:max, y = y)
  
  (ggplot(df,
          aes(x = x, y = y))
    + geom_col()
    + scale_x_continuous(breaks = 1:max,
                         expand = expansion(mult = 0))
    + scale_y_continuous(expand = expansion(mult = c(0, 0.05)))
    + labs(x = "days",
           title = title)
    + theme_bw()
    + theme(
      axis.title.y = element_blank(),
      text = element_text(size = 12)
    )
  )
}
```

```{r plot-mean-gen-int, echo = FALSE, fig.width = 4, fig.height = 2.5, fig.cap = "Generation interval distributino for the mean value of the mean and shape parameter"}
plot_mean_dist(summary.gen.int, max = 21,
               title = "Mean generation interval distribution")
```

```{r plot-mean-inc-per, echo = FALSE, fig.width = 4, fig.height = 2.5, fig.cap = "Incubation period distributino for the mean value of the mean and shape parameter"}
plot_mean_dist(summary.inc.per, max = 8, 
               title = "Mean incubation period distribution")
```

# Fecal shedding distribution

**TODO:** Merge `ww-parameters` vignette into this doc here.
