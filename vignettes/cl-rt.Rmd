---
title: "Estimating effective reproductive number using clinical report data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rt_clinical_data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressMessages({
  library(magrittr)
  library(tidyr)
  library(dplyr)
  library(ggplot2) ; theme_set(theme_bw())
  library(lubridate)
  library(patchwork)
  library(ern)
})
```

With the `ern` package, the effective reproduction number ($\mathcal{R}_t$) can be estimated using clinical reports, aggregated over time (_e.g._ weekly, biweekly). In this vignette, $\mathcal{R}_t$ will be estimated using a subset of weekly COVID-19 reports from the Government of Canada Health Infobase dataset. 

## Loading data and necessary parameters

In order to estimate $\mathcal{R}_t$ from aggregated clinical testing data in `ern`, the following items are required:

- ...

Sample weekly clinical reports are included in `ern`:

```{r load-data}
dat <- ern::cl.input %>% filter(pt == "qc") %>% slice(1:6)
```

The $\mathcal{R}_t$ calculation is as follows:

```{r calculate-Rt}
# define distributions
# - - - - - - - - - - - - - - - - -

pathogen = 'sarscov2'
max.dists = 10 # need to truncate distributions if you're using a very short timeseries

dist.repdelay = list(
  dist = 'gamma',
  mean = 5,
  mean_sd = 1,
  sd = 1,
  sd_sd = 0.1,
  max = 10
)
dist.repfrac = list(
  dist = "unif",
  min = 0.1,
  max = 0.3
)
dist.incub   = def_dist_incubation_period(pathogen)
dist.incub$max = max.dists # need if we're talking fewer data points
dist.gi      = def_dist_generation_interval(pathogen)
dist.gi$max = max.dists

# set various parameters
# - - - - - - - - - - - - - - - - -
popsize = 1e7

prm.daily = list(
  burn = 250,
  iter = 500,
  chains = 1
)
prm.daily.check = list(
  agg.reldiff.tol = 200
)
prm.smooth = list(
  method = "rollmean",
  window = 3
)
prm.R = list(
  iter = 10, # number of iterations in Rt ensemble
  CI = 0.95, # 95% confidence interval
  window = 7, # time window for each Rt estimate
  config.EpiEstim = NULL
)
RL.max.iter = 10

# calculate Rt
# - - - - - - - - - - - - - - - - - 

r.estim = estimate_R_cl(
  cl.input      = dat,
  dist.repdelay = dist.repdelay,
  dist.repfrac  = dist.repfrac,
  dist.incub    = dist.incub,
  dist.gi       = dist.gi,
  popsize       = popsize,
  prm.daily     = prm.daily,
  prm.daily.check = prm.daily.check,
  prm.smooth    = prm.smooth,
  prm.R         = prm.R,
  RL.max.iter   = RL.max.iter,
  silent        = TRUE
)
```

```{r plot-Rt}
plot_diagnostic_cl(r.estim)
```
