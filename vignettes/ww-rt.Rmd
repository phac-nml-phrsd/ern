---
title: "Estimating effective reproductive number using wastewater concentration data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ww-rt}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE, warning=FALSE}
suppressMessages({
  library(tidyr)
  library(dplyr)
  library(ggplot2) ; theme_set(theme_bw())
  library(lubridate)
  library(patchwork)
  library(ern)
})
```

With the `ern` package, the effective reproductive number ($\mathcal{R}_t$) can be estimated using viral concentration data found in wastewater. In this vignette, $\mathcal{R}_t$ will be estimated using a synthetic dataset.

The main function we use to estimate $\mathcal{R}_t$ from wastewater data is `estimate_R_ww()`. This function takes several [inputs](#inputs) and [parameters](#params), described in the next two sections.

## Specifying inputs {#inputs}

`estimate_R_ww()` requires the following inputs from the user:

- `ww.conc`: Viral concentration in wastewater over time, as a data frame with columns `date` (measurement date) and `value` (concentration value)

- Distribution families for several quantities:
  - `dist.fec`: fecal shedding rate
  - `dist.gi`: generation interval

`ern` includes presets for the above families of distribution across several pathogens. See documentations for functions that start with `def_dist_*()` for more details, as well as `vignette('distirbutions', package = 'ern')` for more details on how these presets were derived from literature.

```{r create sample data}
# Creating sample SARS-CoV-2 wastewater data
set.seed(1234)
n=60
x=1:n

value = x * (40 - x) * rnorm(n, mean=1, sd=0.02)
value = value[value>0]

dd = ymd('2022-11-01') + 1:length(value)

ww.conc = data.frame(date = dd, value = value)

head(ww.conc)
```

```{r loading fec shed and gi}
# Loading SARS-CoV-2 fecal shedding and generation interval distributions from ern
dist.fec = ern::def_dist_fecal_shedding('sarscov2')
dist.gi  = ern::def_dist_generation_interval(pathogen = "sarscov2")
```

We can visualize the assumed distributions with `plot_dist()`:

```{r plot distributions, fig.width = 6}
plot_dist(dist.fec) + labs(title = paste0("Mean fecal shedding distribution (", dist.fec$dist, ")"))

plot_dist(dist.gi) + labs(title = paste0("Mean generation interval distribution (", dist.gi$dist, ")"))
```

`plot_dist()` returns a `ggplot` object, and so it can be further annotated with the usual `ggplot2` tools (like `labs()` as above).

Note that `dist.fec` and `dist.gi` define _families_ of distributions (there is uncertainty specified in the mean distribution parameters), while `plot_dist()` only plots the mean distribution in this family.

## Specifying parameters {#params}

`estimate_R_ww()` also takes a number of parameter sets that give the user control over various components of the $\mathcal{R}_t$ estimation:

- `scaling.factor`: a factor used to scale viral concentration in wastewater to prevalence (number of infectious cases in the population at a given point in time)

- `prm.smooth`: smoothing settings for the input wastewater data

- `prm.R`: settings for the $\mathcal{R}_t$ calculation

All of these parameters have defaults, but they can also be adjusted by the user. These settings are further described in the example below, but you may also want to consult the documentation of `estimate_R_ww()` for more details.

```{r initializing smoothing and Rt params}
# Initializing scaling factor
scaling.factor = 1

# Initializing smoothing parameters
prm.smooth = list(
  align  = 'center', # smoothing alignment
  method = 'loess',  # smoothing method
  span   = 0.29      # smoothing span (used for loess smoothing only)
)

# Initialzing Rt settings
prm.R = list(
  iter   = 20,   # number of iterations in Rt ensemble
  CI     = 0.95, # confidence interval
  window = 10,   # Time window for Rt calculations
  config.EpiEstim = NULL # EpiEstim configuration for Rt calculations
)
```

## Estimating $\mathcal{R}_t$

Once the above inputs and parameters are defined, we estimate $\mathcal{R}_t$ as follows:

```{r estimate rt}
r.estim = ern::estimate_R_ww(
  ww.conc        = ww.conc,
  dist.fec       = dist.fec,
  dist.gi        = dist.gi,
  scaling.factor = scaling.factor,
  prm.smooth     = prm.smooth,
  prm.R = prm.R,
  silent = TRUE
)
```

`estimate_R_ww()` returns a list with four elements:

- `ww.conc`: the original input of viral concentration in wastewater over time

- `ww.smooth`: the smoothed wastewater concentration

- `inc`: the daily incidence inferred over time, which is computed by performing a deconvolution of the smoothed wastewater concentration with a fecal shedding distribution. Since we specify a family of fecal shedding distributions, the incidence is computed as an ensemble by repeatedly taking draws from this family of distributions and performing the deconvolution. This ensemble is then summarized for each date with a mean, lower 95% confidence interval (CI) bound, and upper CI bound, which is reported in the `inc` data frame.

- `R`: the daily reproduction number, taken by performing a deconvolution of inferred daily incidence with a generation interval distribution. $\mathcal{R}_t$ is computed in an ensemble by repeatedly taking a draw from the realizations of the inferred incidence and performing the deconvolution with an individual generation interval distribution drawn from the specified family (`dist.gi`). This ensemble is then summarized for each date with a mean, lower CI bound, and upper CI bound. The CI width can be specified by the user in `prm.R`.

## Visualizing $\mathcal{R}_t$ estimates

The output of `estimate_R_ww()` can be visualized readily using `plot_diagnostic_ww()`, which generates a multi-panel plot of three timeseries:

1. original wastewater concentration against the smoothed signal
2. inferred incidence
3. $\mathcal{R}_t$

```{r plot rt, fig.width = 6, fig.height = 6, warning = FALSE}
g = ern::plot_diagnostic_ww(r.estim)
plot(g)
```
